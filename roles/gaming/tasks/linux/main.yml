---
# Tareas para configurar gaming server con Steam

- name: "üìã GAMING SERVER - Informaci√≥n inicial del sistema"
  ansible.builtin.debug:
    msg: |
      ============================================================
      üéÆ CONFIGURANDO ZENTYAL COMO GAMING CENTER üéÆ
      ============================================================
      Timestamp: {{ ansible_date_time.iso8601 }}
      Host: {{ inventory_hostname }} ({{ ansible_host }})
      Usuario actual: {{ ansible_user }}
      
      INFORMACI√ìN DEL SISTEMA:
      - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      - Arquitectura: {{ ansible_architecture }}
      - Memoria total: {{ ansible_memtotal_mb }}MB
      - CPU cores: {{ ansible_processor_vcpus }}
      - Espacio /data: {% if ansible_mounts | selectattr('mount', 'equalto', '/data') | list | length > 0 %}{{ (ansible_mounts | selectattr('mount', 'equalto', '/data') | map(attribute='size_available') | first / 1024 / 1024 / 1024) | round(2) }}GB disponible{% else %}Directorio /data creado{% endif %}
      
      CONFIGURACI√ìN GAMING:
      - Usuario Steam: {{ steam_user }}
      - Directorio Steam: {{ steam_home }}
      - Almacenamiento juegos: {{ games_storage }}
      - Puertos a abrir: {{ gaming_ports | join(', ') }}
      ============================================================

- name: "üìÇ Verificar existencia del directorio /data"
  ansible.builtin.stat:
    path: /data
  register: ansible_stat_data_exists

- name: "‚úÖ Validar que el directorio /data existe y es accesible"
  ansible.builtin.assert:
    that:
      - ansible_stat_data_exists.stat.exists
    fail_msg: |
      ‚ùå ERROR: El directorio /data no est√° disponible
      
      VERIFICACIONES FALLIDAS:
      - /data no encontrado en {{ ansible_host }}
      - Steam necesita /data para almacenamiento
      - Ejecuta: mkdir -p /data en tu servidor
    success_msg: |
      ‚úÖ Directorio /data disponible para Steam
      - Configurado para usar /data en sistema principal

- name: "üì¶ Habilitar arquitectura i386 para compatibilidad Steam"
  ansible.builtin.shell: dpkg --add-architecture i386
  register: i386_result
  changed_when: "'i386' not in ansible_facts.architecture"

- name: "üîÑ Actualizar cache de paquetes despu√©s de i386"
  ansible.builtin.apt:
    update_cache: yes
  when: i386_result.changed

- name: "üì¶ Instalar paquetes necesarios para Steam"
  ansible.builtin.apt:
    name: "{{ steam_packages }}"
    state: present
    update_cache: yes
  register: package_install

- name: "üìã Debug - Resultado instalaci√≥n de paquetes"
  ansible.builtin.debug:
    msg: |
      INSTALACI√ìN DE PAQUETES STEAM:
      {% if package_install.changed %}
      ‚úÖ Paquetes instalados exitosamente:
      {% for pkg in steam_packages %}
      - {{ pkg }}
      {% endfor %}
      {% else %}
      ‚úÖ Todos los paquetes ya estaban instalados
      {% endif %}
      
      Total de paquetes: {{ steam_packages | length }}

- name: "üë• Crear grupo para Steam"
  ansible.builtin.group:
    name: "{{ steam_group }}"
    state: present

- name: "üë§ Crear usuario dedicado para Steam"
  ansible.builtin.user:
    name: "{{ steam_user }}"
    group: "{{ steam_group }}"
    home: "{{ steam_home }}"
    shell: /bin/bash
    create_home: yes
    system: yes
  register: steam_user_created

- name: "üìã Debug - Usuario Steam configurado"
  ansible.builtin.debug:
    msg: |
      USUARIO STEAM CONFIGURADO:
      {% if steam_user_created.changed %}
      ‚úÖ Usuario {{ steam_user }} creado exitosamente
      - Home: {{ steam_home }}
      - Grupo: {{ steam_group }}
      - Shell: /bin/bash
      - Tipo: Usuario del sistema
      {% else %}
      ‚úÖ Usuario {{ steam_user }} ya existe
      {% endif %}

- name: "üìÅ Crear directorios para Steam y juegos"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ steam_user }}"
    group: "{{ steam_group }}"
    mode: '0755'
  loop:
    - "{{ steam_home }}"
    - "{{ games_storage }}"
    - "{{ steam_cache }}"
    - "{{ steam_home }}/steamcmd"
    - "{{ games_storage }}/servers"
    - "{{ gaming_log_path }}"
    - "{{ steam_home }}/scripts"

- name: "‚¨áÔ∏è Descargar SteamCMD"
  ansible.builtin.get_url:
    url: "{{ steamcmd_url }}"
    dest: "{{ steam_home }}/steamcmd_linux.tar.gz"
    owner: "{{ steam_user }}"
    group: "{{ steam_group }}"
    mode: '0644'
  register: steamcmd_download

- name: "üìã Debug - Descarga SteamCMD"
  ansible.builtin.debug:
    msg: |
      DESCARGA STEAMCMD:
      {% if steamcmd_download.changed %}
      ‚úÖ SteamCMD descargado exitosamente
      - URL: {{ steamcmd_url }}
      - Tama√±o: {{ steamcmd_download.msg | default('Descarga completada') }}
      - Ubicaci√≥n: {{ steam_home }}/steamcmd_linux.tar.gz
      - MD5: {{ steamcmd_download.checksum_src | default('N/A') }}
      {% else %}
      ‚úÖ SteamCMD ya estaba descargado
      {% endif %}

- name: "üìÇ Extraer SteamCMD"
  ansible.builtin.unarchive:
    src: "{{ steam_home }}/steamcmd_linux.tar.gz"
    dest: "{{ steam_home }}/steamcmd"
    owner: "{{ steam_user }}"
    group: "{{ steam_group }}"
    remote_src: yes
    creates: "{{ steam_home }}/steamcmd/steamcmd.sh"
  register: steamcmd_extract

- name: "üîß Hacer ejecutable SteamCMD"
  ansible.builtin.file:
    path: "{{ steam_home }}/steamcmd/steamcmd.sh"
    mode: '0755'
    owner: "{{ steam_user }}"
    group: "{{ steam_group }}"

- name: "üî• Configurar firewall UFW para puertos gaming"
  ansible.builtin.ufw:
    rule: allow
    port: "{{ item }}"
    proto: any
  loop: "{{ gaming_ports }}"
  register: firewall_config

- name: "üìã Debug - Configuraci√≥n firewall"
  ansible.builtin.debug:
    msg: |
      CONFIGURACI√ìN FIREWALL GAMING:
      ‚úÖ Puertos configurados para gaming:
      {% for port in gaming_ports %}
      - Puerto {{ port }} (TCP/UDP) - {{ 'Abierto' if port in gaming_ports else 'Cerrado' }}
      {% endfor %}
      
      Total puertos configurados: {{ gaming_ports | length }}
      Estado UFW: Activo con reglas gaming

- name: "‚ö° Aplicar optimizaciones del sistema para gaming"
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop: "{{ gaming_sysctl | dict2items }}"
  register: sysctl_result

- name: "üìã Debug - Optimizaciones del sistema"
  ansible.builtin.debug:
    msg: |
      OPTIMIZACIONES DEL SISTEMA APLICADAS:
      {% for item in sysctl_result.results %}
      {% if item.changed %}
      ‚úÖ {{ item.item.key }}: {{ item.item.value }}
      {% endif %}
      {% endfor %}
      
      Optimizaciones de red para gaming aplicadas correctamente

- name: "üìù Crear script de gesti√≥n de Steam"
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Script de gesti√≥n de Steam para Zentyal Gaming Center
      # Creado por Ansible en {{ ansible_date_time.iso8601 }}
      
      STEAM_HOME="{{ steam_home }}"
      STEAM_USER="{{ steam_user }}"
      GAMES_DIR="{{ games_storage }}"
      LOG_DIR="{{ gaming_log_path }}"
      
      case "$1" in
          start)
              echo "üéÆ Iniciando SteamCMD..."
              sudo -u $STEAM_USER $STEAM_HOME/steamcmd/steamcmd.sh
              ;;
          status)
              echo "üìä Estado del Gaming Server:"
              echo "- Usuario Steam: $STEAM_USER"
              echo "- Directorio Steam: $STEAM_HOME"
              echo "- Juegos: $GAMES_DIR"
              echo "- Logs: $LOG_DIR"
              echo "- Procesos Steam activos:"
              ps aux | grep steam || echo "  Ninguno"
              ;;
          logs)
              echo "üìã Logs del Gaming Server:"
              tail -f $LOG_DIR/*.log 2>/dev/null || echo "No hay logs disponibles"
              ;;
          *)
              echo "üéÆ Zentyal Gaming Center - Gesti√≥n Steam"
              echo "Uso: $0 {start|status|logs}"
              echo ""
              echo "Comandos disponibles:"
              echo "  start  - Iniciar SteamCMD"
              echo "  status - Ver estado del servidor"
              echo "  logs   - Ver logs en tiempo real"
              ;;
      esac
    dest: "{{ steam_home }}/scripts/steam-manager.sh"
    owner: "{{ steam_user }}"
    group: "{{ steam_group }}"
    mode: '0755'

- name: "üîß Verificar instalaci√≥n de Steam ejecutando SteamCMD"
  ansible.builtin.shell: |
    sudo -u {{ steam_user }} {{ steam_home }}/steamcmd/steamcmd.sh +quit
  register: steam_test
  changed_when: false
  failed_when: steam_test.rc != 0

- name: "üìã Debug - Verificaci√≥n final Steam"
  ansible.builtin.debug:
    msg: |
      ============================================================
      üéâ ZENTYAL GAMING CENTER CONFIGURADO EXITOSAMENTE üéâ
      ============================================================
      
      ‚úÖ COMPONENTES INSTALADOS:
      - SteamCMD: {{ steam_home }}/steamcmd/steamcmd.sh
      - Usuario Steam: {{ steam_user }}
      - Directorio juegos: {{ games_storage }}
      - Logs gaming: {{ gaming_log_path }}
      - Script gesti√≥n: {{ steam_home }}/scripts/steam-manager.sh
      
      ‚úÖ CONFIGURACI√ìN DE RED:
      - Puertos abiertos: {{ gaming_ports | join(', ') }}
      - Firewall UFW configurado
      - Optimizaciones de red aplicadas
      
      ‚úÖ COMANDOS √öTILES:
      # Iniciar SteamCMD:
      sudo -u {{ steam_user }} {{ steam_home }}/steamcmd/steamcmd.sh
      
      # Gesti√≥n simplificada:
      {{ steam_home }}/scripts/steam-manager.sh start
      {{ steam_home }}/scripts/steam-manager.sh status
      
      # Acceso web Zentyal:
      https://{{ ansible_host }}:8443
      
      ============================================================
      üéÆ TU ZENTYAL YA ES UN GAMING CENTER üéÆ
      ============================================================

- name: "‚úÖ Assert - Validaci√≥n completa de la instalaci√≥n"
  ansible.builtin.assert:
    that:
      - steam_test.rc == 0
      - steam_user_created is defined
      - steamcmd_download is defined
      - firewall_config is defined
    fail_msg: |
      ‚ùå ERROR EN LA INSTALACI√ìN DEL GAMING SERVER:
      
      VERIFICACIONES FALLIDAS:
      - SteamCMD test: {{ 'FAILED' if steam_test.rc != 0 else 'OK' }}
      - Usuario Steam: {{ 'FAILED' if steam_user_created is not defined else 'OK' }}
      - Descarga SteamCMD: {{ 'FAILED' if steamcmd_download is not defined else 'OK' }}
      - Firewall: {{ 'FAILED' if firewall_config is not defined else 'OK' }}
      
      Revisa los logs y vuelve a ejecutar el playbook.
    success_msg: |
      üéâ ¬°INSTALACI√ìN GAMING SERVER COMPLETADA EXITOSAMENTE!
      
      ‚úÖ VERIFICACIONES EXITOSAS:
      - SteamCMD instalado y funcionando
      - Usuario {{ steam_user }} configurado
      - Firewall configurado para gaming
      - Optimizaciones del sistema aplicadas
      - Scripts de gesti√≥n creados
      
      üéÆ Tu Zentyal est√° listo para ser un Game Center
      üöÄ Puedes empezar a instalar servidores de juegos

---
# Gaming Center: solo para Zentyal o servidores gaming

- name: Optimizar par√°metros de red para gaming
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop: "{{ gaming_sysctl | dict2items }}"
  when: optimize_gaming | default(false)

- name: Instalar dependencias y SteamCMD
  apt:
    name: "{{ steam_packages }}"
    state: present
  when: gaming_enabled | default(false)

- name: Configurar puertos de firewall para gaming
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: any
  loop: "{{ gaming_ports }}"
  when: gaming_enabled | default(false)

- name: Crear usuario steam y carpetas de juegos
  user:
    name: "{{ steam_user }}"
    group: "{{ steam_group }}"
    home: "{{ steam_home }}"
    state: present
  when: gaming_enabled | default(false)

- name: Crear carpetas de almacenamiento de juegos
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ steam_user }}"
    group: "{{ steam_group }}"
    mode: '0775'
  loop:
    - "{{ games_storage }}"
    - "{{ steam_cache }}"
  when: gaming_enabled | default(false)

# ...puedes agregar m√°s tareas espec√≠ficas de gaming aqu√≠...