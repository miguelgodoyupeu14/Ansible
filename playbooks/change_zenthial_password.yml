---
- name: Cambiar contraseña del usuario administrador en Zenthial
  hosts: zenthial
  become: true
  gather_facts: false
  vars:
    # Proporciona la nueva contraseña vía variable de entorno NEW_ZENTHIAL_PASSWORD
    # o mediante --extra-vars new_password=... en la línea de comando.
    new_password: "{{ lookup('env','NEW_ZENTHIAL_PASSWORD') | default(omit) }}"

  tasks:
  - name: Verificar que se proporcionó la nueva contraseña
    ansible.builtin.fail:
      msg: |
        No se proporcionó la nueva contraseña. Exporta NEW_ZENTHIAL_PASSWORD en tu shell
        antes de ejecutar, o pásala como extra-var: `-e new_password=MiNuevaPass`.
    when: new_password is not defined

  - name: Construir hash de la nueva contraseña (sha512)
    ansible.builtin.set_fact:
      new_password_hashed: "{{ new_password | password_hash('sha512') }}"

  - name: Cambiar la contraseña del usuario administrador (`{{ admin_user }}`)
    ansible.builtin.user:
      name: "{{ admin_user }}"
      password: "{{ new_password_hashed }}"
    register: changed_pw

  - name: Mostrar resultado (no mostrar la contraseña)
    ansible.builtin.debug:
      msg: "Contraseña para {{ admin_user }} actualizada: {{ 'OK' if changed_pw.changed else 'NO CHANGED' }}"
