---

# PLAYBOOK PRINCIPAL - Separado por SO

- name: "ğŸš€ CONFIGURACIÃ“N COMPLETA DEL SISTEMA ANSIBLE (Linux)"
  hosts: linux_servers
  become: true
  gather_facts: yes
  vars_files:
  - secrets.yml
  pre_tasks:
  - name: "ğŸ“‹ INICIO - InformaciÃ³n del sistema y configuraciÃ³n"
    ansible.builtin.debug:
      msg: |
        ============================================================
        ğŸš€ ANSIBLE PROJECT - CONFIGURACIÃ“N COMPLETA
        ============================================================
        ğŸ“… Fecha: {{ ansible_date_time.iso8601 }}
        ğŸ–¥ï¸  Host: {{ inventory_hostname }} ({{ ansible_host | default('N/A') }})
        ğŸ§ SO: {{ ansible_facts['distribution'] | default('Unknown') }} {{ ansible_facts['distribution_version'] | default('') }}
        ğŸ—ï¸  Arquitectura: {{ ansible_facts['architecture'] | default('Unknown') }}
        ğŸ‘¤ Usuario: {{ ansible_user }}
        ğŸŒ Plataforma: {{ ansible_facts['os_family'] | default('Unknown') }}

        ğŸ¯ CONFIGURACIÃ“N A EJECUTAR:
        âœ… ConfiguraciÃ³n base del sistema
        âœ… GestiÃ³n de usuarios y seguridad
        âœ… ConfiguraciÃ³n de servicios
        âœ… ConfiguraciÃ³n de almacenamiento
        {% if gaming_enabled | default(false) %}
        ğŸ® Gaming Center (Steam + Servidores de juegos)
        {% endif %}
        âœ… AuditorÃ­a y monitoreo

        ============================================================
        ğŸš€ INICIANDO CONFIGURACIÃ“N COMPLETA...
        ============================================================

  - name: "ğŸ”‘ AÃ±adir host a known_hosts si es necesario (omitido)"
    ansible.builtin.debug:
      msg: "Tarea de gestiÃ³n de known_hosts omitida. Ejecuta 'ssh-keyscan -H <host> >> ~/.ssh/known_hosts' en el controlador si es necesario."
    run_once: true
    when:
    - ansible_host is defined
    - ansible_facts['os_family'] != 'Windows'

  - name: " Verificar conectividad Linux"
    ansible.builtin.ping:
    when: ansible_facts['os_family'] != 'Windows'

  - name: "ğŸ“¦ Verificar que Python estÃ¡ disponible (Linux)"
    ansible.builtin.setup:
      gather_subset: min
    when: ansible_facts['os_family'] != 'Windows'

  roles:
  - base
  - users
  - services
  - storage
  - { role: gaming, when: (gaming_enabled | default(false)) | bool }
  - audit

  post_tasks:
  - name: "ğŸ‰ FINALIZACIÃ“N - Resumen de configuraciÃ³n completada"
    ansible.builtin.debug:
      msg: |
        ============================================================
        ğŸ‰ Â¡CONFIGURACIÃ“N COMPLETADA EXITOSAMENTE! ğŸ‰
        ============================================================

        âœ… COMPONENTES CONFIGURADOS:
        ğŸ“‹ Sistema base: Paquetes, timezone, firewall, SSH
        ğŸ‘¥ Usuarios: Cuentas admin, SSH keys, sudoers
        âš™ï¸  Servicios: Servicios crÃ­ticos habilitados y monitoreados
        ğŸ’¾ Almacenamiento: Discos y particiones configurados
        {% if (gaming_enabled | default(false)) | bool %}
        ğŸ® Gaming Center: Steam + servidores de juegos listos
        {% endif %}
        ğŸ“Š AuditorÃ­a: Logs y reportes configurados

        ğŸ–¥ï¸  INFORMACIÃ“N DEL SERVIDOR:
        - Host: {{ inventory_hostname }}
        - IP: {{ ansible_host | default(ansible_default_ipv4.address | default('N/A')) }}
        - SO: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
        - Memoria: {{ ansible_memtotal_mb | default('N/A') }}MB
        - CPU: {{ ansible_processor_vcpus | default('N/A') }} cores

        {% if (gaming_enabled | default(false)) | bool %}
        ğŸ® GAMING CENTER INFORMACIÃ“N:
        - Steam configurado para usuario: {{ steam_user | default('steamuser') }}
        - Directorio juegos: {{ games_storage | default('/data/games') }}
        - Puertos gaming abiertos: {{ gaming_ports | join(', ') if gaming_ports is defined else 'N/A' }}
        - Acceso web Zentyal: https://{{ ansible_host | default('IP') }}:8443
        {% endif %}

        ğŸš€ COMANDOS ÃšTILES POST-CONFIGURACIÃ“N:
        # Verificar estado general:
        ansible {{ inventory_hostname }} -m setup

        # Ejecutar solo gaming (si habilitado):
        ansible-playbook main.yml --tags gaming

        # Ejecutar solo servicios:
        ansible-playbook main.yml --tags services

        # AuditorÃ­a completa:
        ansible-playbook main.yml --tags audit

        ============================================================
        ğŸ¯ TU SISTEMA ESTÃ LISTO Y OPERATIVO
        ============================================================

  - name: "ğŸ“Š Recopilar facts finales del sistema"
    ansible.builtin.setup:
      gather_subset: all
    register: final_facts

  - name: "âœ… ValidaciÃ³n final - Confirmar que todo estÃ¡ funcionando"
    ansible.builtin.assert:
      that:
      - ansible_facts is defined
      - ansible_facts['os_family'] is defined
      - final_facts is defined
      fail_msg: |
        âŒ ERROR: ValidaciÃ³n final fallida
        Algunos componentes no se configuraron correctamente.
        Revisa los logs anteriores para identificar problemas.
      success_msg: |
        âœ… VALIDACIÃ“N EXITOSA: Todo configurado correctamente
        Sistema listo para producciÃ³n.

  - name: "ğŸ® Gaming Center - Mensaje final (si habilitado)"
    ansible.builtin.debug:
      msg: |
        ğŸ®ğŸ‰ Â¡TU ZENTYAL ES AHORA UN GAMING CENTER! ğŸ‰ğŸ®

        Steam estÃ¡ instalado y listo
        Puedes empezar a instalar servidores de juegos
        GestiÃ³n: {{ steam_home | default('/data/steam') }}/scripts/steam-manager.sh
    when: (gaming_enabled | default(false)) | bool

- name: "ğŸš€ CONFIGURACIÃ“N COMPLETA DEL SISTEMA ANSIBLE (Windows)"
  hosts: windows_servers
  become: true
  become_method: runas
  gather_facts: yes
  vars_files:
  - secrets.yml
  pre_tasks:
  - name: "ğŸ“‹ INICIO - InformaciÃ³n del sistema y configuraciÃ³n"
    ansible.builtin.debug:
      msg: |
        ============================================================
        ğŸš€ ANSIBLE PROJECT - CONFIGURACIÃ“N COMPLETA
        ============================================================
        ğŸ“… Fecha: {{ ansible_date_time.iso8601 }}
        ğŸ–¥ï¸  Host: {{ inventory_hostname }} ({{ ansible_host | default('N/A') }})
        ğŸ§ SO: {{ ansible_facts['distribution'] | default('Unknown') }} {{ ansible_facts['distribution_version'] | default('') }}
        ğŸ—ï¸  Arquitectura: {{ ansible_facts['architecture'] | default('Unknown') }}
        ğŸ‘¤ Usuario: {{ ansible_user }}
        ğŸŒ Plataforma: {{ ansible_facts['os_family'] | default('Unknown') }}

        ğŸ¯ CONFIGURACIÃ“N A EJECUTAR:
        âœ… ConfiguraciÃ³n base del sistema
        âœ… GestiÃ³n de usuarios y seguridad
        âœ… ConfiguraciÃ³n de servicios
        âœ… ConfiguraciÃ³n de almacenamiento
        âœ… AuditorÃ­a y monitoreo

        ============================================================
        ğŸš€ INICIANDO CONFIGURACIÃ“N COMPLETA...
        ============================================================

  - name: "ğŸ” Verificar conectividad Windows"
    ansible.windows.win_ping:


  roles:
  - base
  - users
  - services
  - storage
  - audit

  post_tasks:
  - name: "ğŸ‰ FINALIZACIÃ“N - Resumen de configuraciÃ³n completada"
    ansible.builtin.debug:
      msg: |
        ============================================================
        ğŸ‰ Â¡CONFIGURACIÃ“N COMPLETADA EXITOSAMENTE! ğŸ‰
        ============================================================

        âœ… COMPONENTES CONFIGURADOS:
        ğŸ“‹ Sistema base: Paquetes, timezone, firewall
        ğŸ‘¥ Usuarios: Cuentas admin, polÃ­ticas de grupo
        âš™ï¸  Servicios: Servicios crÃ­ticos habilitados y monitoreados
        ğŸ’¾ Almacenamiento: Discos y volÃºmenes configurados
        ğŸ“Š AuditorÃ­a: Logs y reportes configurados

        ğŸ–¥ï¸  INFORMACIÃ“N DEL SERVIDOR:
        - Host: {{ inventory_hostname }}
        - IP: {{ ansible_host | default(ansible_default_ipv4.address | default('N/A')) }}
        - SO: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
        - Memoria: {{ ansible_memtotal_mb | default('N/A') }}MB
        - CPU: {{ ansible_processor_vcpus | default('N/A') }} cores

        ğŸš€ COMANDOS ÃšTILES POST-CONFIGURACIÃ“N:
        # Verificar estado general:
        ansible {{ inventory_hostname }} -m setup

        # Ejecutar solo servicios:
        ansible-playbook main.yml --tags services

        # AuditorÃ­a completa:
        ansible-playbook main.yml --tags audit

        ============================================================
        ğŸ¯ TU SISTEMA WINDOWS ESTÃ LISTO Y OPERATIVO
        ============================================================

  - name: "ğŸ“Š Recopilar facts finales del sistema"
    ansible.builtin.setup:
      gather_subset: all
    register: final_facts

  - name: "âœ… ValidaciÃ³n final - Confirmar que todo estÃ¡ funcionando"
    ansible.builtin.assert:
      that:
      - ansible_facts is defined
      - ansible_facts['os_family'] is defined
      - final_facts is defined
      fail_msg: |
        âŒ ERROR: ValidaciÃ³n final fallida
        Algunos componentes no se configuraron correctamente.
        Revisa los logs anteriores para identificar problemas.
      success_msg: |
        âœ… VALIDACIÃ“N EXITOSA: Todo configurado correctamente
        Sistema listo para producciÃ³n.
